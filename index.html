<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EU Resort Junk Fee Removal</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }

    .container { max-width: 1500px; margin: 0 auto; }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px 30px;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    header h1 { font-size: 22px; }
    header p { opacity: 0.85; font-size: 13px; margin-top: 4px; }

    /* ‚îÄ‚îÄ Controls Panel ‚îÄ‚îÄ */
    .controls-panel {
      background: #16213e;
      border-radius: 10px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .form-group label {
      font-size: 11px;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-group input {
      padding: 9px 12px;
      background: #0f3460;
      border: 1px solid #2a2a4a;
      border-radius: 6px;
      color: #eee;
      font-size: 13px;
    }
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .fg-api  { flex: 2; min-width: 240px; }
    .fg-resort { flex: 0 0 120px; }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    button {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button:disabled { opacity: 0.45; cursor: default; transform: none; }

    .btn-run {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 10px 36px;
      font-size: 14px;
    }
    .btn-run:hover:not(:disabled) {
      box-shadow: 0 4px 15px rgba(102,126,234,0.4);
    }

    .btn-cancel {
      background: #5f1e1e;
      color: #ef9a9a;
      padding: 10px 24px;
      display: none;
    }
    .btn-cancel:hover { background: #7a2828; }

    .btn-load {
      background: transparent;
      color: #667eea;
      border: 1px solid #667eea;
      padding: 10px 18px;
    }
    .btn-load:hover { background: rgba(102,126,234,0.1); }

    .btn-highlight {
      background: transparent;
      color: #f0c040;
      border: 1px solid #f0c040;
      padding: 10px 18px;
    }
    .btn-highlight:hover { background: rgba(240,192,64,0.1); }
    .btn-highlight.active {
      background: rgba(240,192,64,0.15);
      box-shadow: 0 0 8px rgba(240,192,64,0.25);
    }

    /* ‚îÄ‚îÄ Status Bar ‚îÄ‚îÄ */
    .status-bar {
      width: 100%;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 13px;
      display: none;
      margin-top: 4px;
    }
    .status-bar.loading { display: block; background: rgba(33,150,243,0.15); color: #64b5f6; }
    .status-bar.success { display: block; background: rgba(76,175,80,0.15); color: #81c784; }
    .status-bar.error   { display: block; background: rgba(244,67,54,0.15); color: #ef9a9a; }

    /* ‚îÄ‚îÄ Section Headers ‚îÄ‚îÄ */
    .section-title {
      color: #a5b4fc;
      font-size: 16px;
      margin: 28px 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ‚îÄ‚îÄ Side-by-Side Grid ‚îÄ‚îÄ */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .card {
      background: #0f3460;
      border: 1px solid #2a2a4a;
      border-radius: 10px;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }
    .card h3 {
      font-size: 13px;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }
    .card.original h3 { color: #64b5f6; }
    .card.updated  h3 { color: #81c784; }

    .card pre {
      flex: 1;
      min-height: 220px;
      max-height: 500px;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      background: #1a1a2e;
      border-radius: 6px;
      padding: 12px;
      color: #ddd;
    }

    /* ‚îÄ‚îÄ Fee Highlighting ‚îÄ‚îÄ */
    .fee-highlight {
      background: rgba(240,192,64,0.25);
      color: #f0c040;
      border-radius: 3px;
      padding: 0 2px;
    }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      .controls-panel { flex-direction: column; align-items: stretch; }
      .fg-resort { flex: 1; }
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- Header -->
    <header>
      <div>
        <h1>üè® EU Resort Junk Fee Removal</h1>
        <p>RAI &amp; Policies ‚Äî Langflow Execution UI</p>
      </div>
      <span id="timer" style="font-size:13px; opacity:0.8;"></span>
    </header>

    <!-- Controls -->
    <div class="controls-panel">
      <div class="form-group fg-api">
        <label>Langflow API Key</label>
        <input id="apiKeyInput" type="password" placeholder="Paste your Langflow API key" />
      </div>
      <div class="form-group fg-resort">
        <label>Resort ID</label>
        <input id="resortIdInput" type="text" value="5642" placeholder="e.g. 5642" />
      </div>

      <button class="btn-run" id="runBtn" onclick="runFlow()">üöÄ Run Flow</button>
      <button class="btn-cancel" id="cancelBtn" onclick="cancelFlow()">‚úñ Cancel</button>
      <button class="btn-load" id="loadBtn" onclick="loadOriginalPrompts()">üì• Load from Langflow</button>
      <button class="btn-highlight" id="highlightBtn" onclick="toggleHighlight()">üí∞ Highlight Fees</button>

      <div id="status" class="status-bar" role="status" aria-live="polite"></div>
    </div>

    <!-- POLICIES -->
    <div class="section-title">üìã Policies</div>
    <div class="grid">
      <div class="card original">
        <h3>Original Policies</h3>
        <pre id="origPolicies">Waiting for flow‚Ä¶</pre>
      </div>
      <div class="card updated">
        <h3>Updated Policies</h3>
        <pre id="updatedPolicies">Waiting for flow‚Ä¶</pre>
      </div>
    </div>

    <!-- RAI -->
    <div class="section-title">üìù Arrival Info (RAI)</div>
    <div class="grid">
      <div class="card original">
        <h3>Original RAI</h3>
        <pre id="origRAI">Waiting for flow‚Ä¶</pre>
      </div>
      <div class="card updated">
        <h3>Updated RAI</h3>
        <pre id="updatedRAI">Waiting for flow‚Ä¶</pre>
      </div>
    </div>

  </div>

  <script>
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CONFIG
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    const API_BASE = 'https://langflow-staging.leavetown.com';
    const FLOW_ID  = '8cda597f-c9c5-4440-827d-862142a271f9';
    const API_URL  = `${API_BASE}/api/v1/run/${FLOW_ID}`;

    /* Map UI panes ‚Üí Langflow node IDs */
    const NODE_MAP = {
      origPolicies:    'DynamicFieldExtractor-sHpfr',
      updatedPolicies: 'Prompt Template-AVk4F',
      origRAI:         'DynamicFieldExtractor-4KJ4n',
      updatedRAI:      'Prompt Template-9r1K1'
    };

    /* Fee-related keywords to highlight */
    const FEE_KEYWORDS = [
      'fee', 'fees', 'surcharge', 'surcharges', 'charge', 'charges',
      'resort fee', 'cleaning fee', 'service fee', 'booking fee',
      'amenity fee', 'facility fee', 'destination fee',
      'tax', 'taxes', 'vat', 'levy',
      'cost', 'price', 'payment', 'deposit',
      'hidden', 'mandatory', 'compulsory', 'obligatory',
      'extra', 'additional', 'supplement'
    ];

    let controller = null;   // AbortController for cancellation
    let timerInterval = null;
    let highlightOn = false;

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       HELPERS
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function $(id) { return document.getElementById(id); }

    function setStatus(msg, type) {
      const el = $('status');
      el.textContent = msg;
      el.className = 'status-bar' + (type ? ' ' + type : '');
    }

    function extract(outputs, nodeId) {
      for (const group of outputs) {
        const items = group.outputs || [];
        for (const item of items) {
          if (item.component_id === nodeId) {
            return item.results?.message?.text || '‚Äî No output ‚Äî';
          }
        }
      }
      return '‚Äî No output ‚Äî';
    }

    function startTimer() {
      const start = Date.now();
      $('timer').textContent = '‚è± 0s';
      timerInterval = setInterval(() => {
        const s = Math.round((Date.now() - start) / 1000);
        $('timer').textContent = `‚è± ${s}s`;
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       RUN FLOW
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    async function runFlow() {
      const key  = $('apiKeyInput').value.trim();
      const rid  = $('resortIdInput').value.trim();

      if (!key) { setStatus('‚ö† API key is required.', 'error'); return; }
      if (!rid) { setStatus('‚ö† Resort ID is required.', 'error'); return; }

      /* UI state */
      $('runBtn').disabled = true;
      $('cancelBtn').style.display = 'inline-block';
      setStatus('‚è≥ Running Langflow flow‚Ä¶', 'loading');
      startTimer();

      /* Reset panels */
      ['origPolicies','updatedPolicies','origRAI','updatedRAI'].forEach(id => {
        $(id).textContent = 'Loading‚Ä¶';
      });

      /* AbortController for cancel */
      controller = new AbortController();

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          signal: controller.signal,
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': key
          },
          body: JSON.stringify({
            input_type:  'chat',
            output_type: 'chat',
            input_value: rid
          })
        });

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(`HTTP ${res.status}: ${errText.substring(0, 200)}`);
        }

        const data = await res.json();
        const outputs = data.outputs || [];

        /* Populate panels */
        $('origPolicies').textContent    = extract(outputs, NODE_MAP.origPolicies);
        $('updatedPolicies').textContent = extract(outputs, NODE_MAP.updatedPolicies);
        $('origRAI').textContent         = extract(outputs, NODE_MAP.origRAI);
        $('updatedRAI').textContent      = extract(outputs, NODE_MAP.updatedRAI);

        setStatus('‚úÖ Flow completed successfully!', 'success');

        /* Re-apply highlighting if it was on */
        if (highlightOn) applyHighlight();

      } catch (e) {
        if (e.name === 'AbortError') {
          setStatus('üõë Flow cancelled by user.', 'error');
          ['origPolicies','updatedPolicies','origRAI','updatedRAI'].forEach(id => {
            if ($(id).textContent === 'Loading‚Ä¶') $(id).textContent = 'Cancelled.';
          });
        } else {
          setStatus('‚ùå ' + e.message, 'error');
        }
      } finally {
        $('runBtn').disabled = false;
        $('cancelBtn').style.display = 'none';
        controller = null;
        stopTimer();
      }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CANCEL FLOW
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function cancelFlow() {
      if (controller) controller.abort();
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       LOAD ORIGINAL PROMPTS FROM LANGFLOW
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    async function loadOriginalPrompts() {
      const key = $('apiKeyInput').value.trim();
      if (!key) { setStatus('‚ö† API key required to load prompts.', 'error'); return; }

      setStatus('üì• Loading prompt templates from Langflow‚Ä¶', 'loading');

      try {
        const res = await fetch(`${API_BASE}/api/v1/flows/${FLOW_ID}`, {
          headers: { 'x-api-key': key }
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const flow = await res.json();
        const nodes = flow.data?.nodes || [];

        let loaded = 0;

        /* Try to find prompt template nodes and display their templates */
        for (const node of nodes) {
          const nid = node.id || '';
          const template = node.data?.node?.template;
          if (!template) continue;

          /* Check if this is one of our mapped nodes */
          if (nid === NODE_MAP.updatedPolicies || nid === NODE_MAP.updatedRAI) {
            const promptField = template.template?.value || template.prompt?.value || '';
            if (promptField) {
              const targetId = nid === NODE_MAP.updatedPolicies ? 'updatedPolicies' : 'updatedRAI';
              $(targetId).textContent = '‚îÄ‚îÄ PROMPT TEMPLATE ‚îÄ‚îÄ\\n\\n' + promptField;
              loaded++;
            }
          }

          if (nid === NODE_MAP.origPolicies || nid === NODE_MAP.origRAI) {
            const fields = Object.keys(template).filter(k => typeof template[k] === 'object');
            const info = fields.map(k => `${k}: ${template[k]?.value || '(not set)'}`).join('\\n');
            if (info) {
              const targetId = nid === NODE_MAP.origPolicies ? 'origPolicies' : 'origRAI';
              $(targetId).textContent = '‚îÄ‚îÄ NODE CONFIG ‚îÄ‚îÄ\\n\\n' + info;
              loaded++;
            }
          }
        }

        if (loaded > 0) {
          setStatus(`‚úÖ Loaded ${loaded} node config(s) from Langflow.`, 'success');
        } else {
          setStatus('‚ö† Flow loaded but no matching prompt templates found. Run the flow instead.', 'error');
        }

      } catch (e) {
        setStatus('‚ùå Could not load flow: ' + e.message, 'error');
      }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       HIGHLIGHT FEES
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function toggleHighlight() {
      highlightOn = !highlightOn;
      $('highlightBtn').classList.toggle('active', highlightOn);

      if (highlightOn) {
        applyHighlight();
      } else {
        removeHighlight();
      }
    }

    function applyHighlight() {
      ['origPolicies','updatedPolicies','origRAI','updatedRAI'].forEach(id => {
        const el = $(id);
        const text = el.textContent;
        /* Build regex from fee keywords */
        const pattern = new RegExp(
          '(' + FEE_KEYWORDS.map(k => k.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')).join('|') + ')',
          'gi'
        );
        el.innerHTML = text.replace(pattern, '<span class="fee-highlight">$1</span>');
      });
    }

    function removeHighlight() {
      ['origPolicies','updatedPolicies','origRAI','updatedRAI'].forEach(id => {
        const el = $(id);
        el.textContent = el.textContent; /* strips HTML, keeps text */
      });
    }
  </script>
</body>
</html>
